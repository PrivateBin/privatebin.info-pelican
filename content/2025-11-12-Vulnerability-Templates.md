Title: Vulnerability Report: Template-switching feature allowing arbitrary local file inclusion through path traversal
Date: 2025-11-12 08:15
Category: Reports
Tags: PrivateBin, Security
Slug: reports/vulnerability-2025-11-12-templates
Authors: rugk, El RIDO
Summary: An unauthenticated Local File Inclusion exists in the template-switching feature.

An unauthenticated Local File Inclusion exists in the template-switching feature: if `templateselection` is enabled in the configuration, the server trusts the `template` cookie and includes the referenced PHP file. An attacker can read sensitive data or, if they manage to drop a PHP file elsewhere, gain RCE.

## Affected versions

PrivateBin versions since 1.7.7.

## Conditions

- `templateselection` got enabled in `cfg/conf.php`
- Visitor sets a cookie `template` pointing to an existing PHP file without it's suffix, using a path relative to the `tpl` folder. Absolute paths do not work.

## Impact

The constructed path of the template file is checked for existence, then included. For PrivateBin project files this does not leak any secrets due to data files being created with PHP code that prevents execution, but if a configuration file without that line got created or the visitor figures out the relative path to a PHP script that directly performs an action without appropriate privilege checking, those might execute or leak information.

### Real-life impact

We checked all instances versioned 1.7.7 and above listed in the [PrivateBin directory](https://privatebin.info/directory/) and did find 11 instances that had the template switcher enabled. We used the following script to detect this:

```
for URL in $(
    curl --silent --header 'Accept: application/json' 'https://privatebin.info/directory/api?top=100&version=1.7.7' | jq --raw-output '.[].url'
) $(
    curl --silent --header 'Accept: application/json' 'https://privatebin.info/directory/api?top=100&version=1.7.8' | jq --raw-output '.[].url'
) $(
    curl --silent --header 'Accept: application/json' 'https://privatebin.info/directory/api?top=100&version=2'     | jq --raw-output '.[].url'
)
do
    curl --silent "$URL" | grep -q 'id="template"' && echo "$URL uses template switcher"
done
```

None of these instances had an unprotected PrivateBin configuration file in use. We used the following script, that may be adapted to check any single instance:

```
curl --silent --cookie  'template=../cfg/conf' https://privatebin.net
```

## Technical Description

Users can select their preferred template via the `template` cookie, as seen in `TemplateSwitcher::getSelectedByUserTemplate`:

```
    private static function getSelectedByUserTemplate(): ?string
    {
        $selectedTemplate    = null;
        $templateCookieValue = $_COOKIE['template'] ?? '';

        if (self::isTemplateAvailable($templateCookieValue)) {
            $selectedTemplate = $templateCookieValue;
        }

        return $selectedTemplate;
    }
```

In [this commit](https://github.com/PrivateBin/PrivateBin/commit/44f8cfbfb8df4b4bec1cbf79aa8ce51abdb18be3), introduced in 1.7.7, the `TemplateSwitcher::isTemplateAvailable` method went from this:

```
    public static function isTemplateAvailable(string $template): bool
    {
        return in_array($template, self::getAvailableTemplates());
    }
```

to this:

```
    public static function isTemplateAvailable(string $template): bool
    {
        $available = in_array($template, self::getAvailableTemplates());

        if (!$available && !View::isBootstrapTemplate($template)) {
            $path      = View::getTemplateFilePath($template);
            $available = file_exists($path);
        }

        return $available;
    }
```

The new code will now blindly trust `$template`, unless it starts with the string `bootstrap-`.

`View::getTemplateFilePath` will return `PATH . 'tpl' . DIRECTORY_SEPARATOR . $file . '.php'`, allowing directory traversal, but preventing non-PHP files to be included.

`View::draw` will then include the user-submitted template:

```
    public function draw($template)
    {
        $path = self::getTemplateFilePath($template);
        if (!file_exists($path)) {
            throw new Exception('Template ' . $template . ' not found!', 80);
        }
        extract($this->_variables);
        include $path;
    }
```

**Note:** this is only possible if `templateselection` configuration is enabled, or if no template has been set. The `template` will be rewritten if this condition isn't met:

```
    private function _setDefaultTemplate()
    {
        $templates = $this->_conf->getKey('availabletemplates');
        $template  = $this->_conf->getKey('template');
        TemplateSwitcher::setAvailableTemplates($templates);
        TemplateSwitcher::setTemplateFallback($template);

        // force default template, if template selection is disabled and a default is set
        if (!$this->_conf->getKey('templateselection') && !empty($template)) {
            $_COOKIE['template'] = $template;
            setcookie('template', $template, array('SameSite' => 'Lax', 'Secure' => true));
        }
    }
```

### Reproduction Steps

1. Configure PrivateBin with templateselection = true (default template list is fine).
2. Send a request with a malicious template cookie like `template=../cfg/conf`, where the relative path points to a PHP file without its file suffix
3. The script now includes the select PHP file (leading to a 500 in that specific case).

## Mitigation

### Patches

The issue has been patched in version 2.0.3.

### Workarounds

Set `templateselection = false` in `cfg/conf.php` or remove it, it's default is `false`.

## Credits

We'd like to thank [Benoit Esnard](https://github.com/esnard), who reported this vulnerability.

In general, we'd like to thank everyone reporting issues and potential vulnerabilities to us.

If you think you have found a vulnerability or potential security risk, [we'd kindly ask you to follow our security policy](https://github.com/PrivateBin/PrivateBin/blob/master/SECURITY.md) and report it to us. We then assess the report and will take the actions we deem necessary to address it.

## Timeline

- 2025-11-09 Received report via GitHub Security Advisory
- 2025-11-10 Discussed and reproduced issue, wrote a unit test case based on this, started work on a patch
- 2025-11-11 Further work on patch, refactored related code
- 2025-11-12 Released patch with PrivateBin 2.0.3
