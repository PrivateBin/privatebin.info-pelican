Title: Vulnerability Report
Date: 2020-01-11 15:00
Category: Reports
Tags: PrivateBin, Security
Slug: reports/vulnerability-2020-01-11
Authors: rugk, El RIDO
Summary: On 25th of December 2019 a vulnerability to HTML injections was discovered, which has been fixed in [PrivateBin v1.3.2 & v1.2.2](https://privatebin.info/news/v1.3.2-release.html).

On 24th of December 2019 one of the [property based unit tests](https://github.com/PrivateBin/PrivateBin/blob/master/tst/README.md#property-based-unit-testing) reported a [failure](https://travis-ci.org/PrivateBin/PrivateBin/jobs/629180605#L782). Upon investigation on the next day, [@elrido](https://github.com/elrido) discovered that the failure was due to unescaped HTML, which allowed the user provided attachment file name to inject HTML under certain conditions. After committing an [initial fix](https://github.com/PrivateBin/PrivateBin/commit/8d0ac336d23cd8c98e71d5f21cdadcae9c8a26e6) to the master branch, the [issue was reported](https://github.com/PrivateBin/PrivateBin/issues/554) on 25th of December. Vulnerability write-up done by [@rugk](https://github.com/rugk) and [@elrido](https://github.com/elrido).  
The vulnerability has been fixed in [PrivateBin v1.3.2 & v1.2.2](https://privatebin.info/news/v1.3.2-release.html). Admins are urged to upgrade to these versions to protect the affected users.

## Affected versions

Any PrivateBin version since 1.2.

## Conditions

* The configuration setting `fileupload` has to be enabled, as 1.3 displays an error when trying to open a paste with attachment.
* The CSP headers have either:
  * been disabled/commented in the PHP-logic or...
  * have been relaxed in the `cspheader` configuration setting
* A paste with a malicious filename is created
* A visitor of that paste clicks on the "Clone" button

## Steps to reproduce

The following method is just one possibility to exploit this issue and is provided as a proof of concept. In order avoid having to create an actual file with a malicious filename, one could use the [Python CLI client for PrivateBin](https://github.com/r4sas/PBinCLI/) and [edit line 56 in `format.py`](https://github.com/r4sas/PBinCLI/blob/682b47fbd3e24a8a53c3b484ba896a5dbc85cda2/pbincli/format.py#L56) as follows:

```python
         self._attachment_name = '<script>alert("☹️");//<a'
```

The paste then can created on a vulnerable instance:

```shell
python pbincli/cli.py send -t " " -f /dev/null -s https://privatebin.net/
```

Visiting the created paste on a vulnerable instance, with `fileupload` enabled and the CSP header weakened or disabled, and clicking the clone button will insert the HTML unescaped. In the above example, a pop-up would appear, when the script is executed.

## Impact

On a vulnerable site pastes with malicious filenames can be created and users visiting these could inadvertedly trigger the code execution when they click the "Clone" button. They could be instigated to do so via social queues, like a paste text suggesting to "clone and share" the paste in question.

The file itself doesn't have to empty and could be an image or document that would still be displayed inline as usual. The execution of the script triggered by clicking on the "Clone" button may occur silently in the background without showing any noticable signs in browser. It may just track visitors or be used for drive-by-downloads.

On first visit, the filename isn't visible. Only when clicking the "Download attachment" link would open a file save dialog with an odd name prefilled, although browsers will convert illegal characters into valid ones, so it may not be identical to the one provided. Only after the "Clone" button is clicked, after the malicious filename was already inserted is the filename displayed. This can be obfuscated by starting the malicious filename with something harmless, like `image.png`, before opening the HTML tag.

## Real-life impact

We checked all instances listed in the [PrivateBin directory in the Wiki](https://github.com/PrivateBin/PrivateBin/wiki/PrivateBin-Directory) and didn't find any 1.1, 1.2 or 1.3 instances that had the CSP headers disabled or in a vulnarable state:

```shell
for URL in $(curl -s https://raw.githubusercontent.com/wiki/PrivateBin/PrivateBin/PrivateBin-Directory.md | grep -Po '^http.*?(?= )'); do echo -n "$URL: "; curl -sLI $URL | grep -Poi 'content-security-policy.*script-src.?\K.*?(?=;)' || echo 'No CSP detected!'; done
```

Some of the above sites do offer file uploads. On these instances, it is still possible that a visitor could have CSP support disabled in their browser, i.e. via a transparent proxy at their internet uplink or due to a browser plugin or some other locally installed, misguided security solution.

## Mitigation

As server administrators can't detect if a paste contains file attachments at all (apart from their size) with Version 1.3 and due to the encrypted filename in older versions, as well as the risk for clients that don't apply the CSP settings, we urge them to upgrade to versions 1.3.2 or 1.2.2.

## Further information

While it is satisfying that our hard work on introducing unit tests has payed off in the discovery and mitigation of this vulnerabilty, it does also show a limitation of unit testing. A third party doing a code review would have certainly focused on how the project handles user provided input and may have discovered this much quicker.

The discovery wasn't due to the unit test checking for HTML input to get properly escaped, on the contrary, the test assumed input would not be changed. So other instances of HTML tags generated would have happily passed the test. Only when the test generated a fragment of a link (`<a`) it failed, because the DOM silently removed it when it inserted the string, as links within links aren't allowed. While the test was written to throw arbitrary strings at the `AttachmentViewer.moveAttachmentTo()` method, the test would only check that these got inserted into the DOM unchanged, oblivious of their potential significance when interpreted as HTML.

The [test had been introduced](https://github.com/PrivateBin/PrivateBin/commit/39860dfdc434c00d18342b4fb3bc6f5d0960030d) on December 3rd, 2017, 570 commits ago. Every commit on master and in PRs triggers these tests to run for every supported PHP version. Additional test cicles get run on developers local environments during working on commits. Hence the test suite must have run a few thousand times, testing 100 random strings each time. And only after more then 2 years a string containing `<a` got generated, triggered the error condition and 22 shrinks later the smallest failing test case was presented as:

```
Failed after 65 tests and 22 shrinks. rngState: 8b8f0d4ec2a67139b5; Counterexample: "image/png"; ""; "\u0000"; "<a"; "";
```

It should also be mentioned, that the coverage report did highlight the line that caused this vulnerability as not being covered in testing:

[insert image here, as coverage report is updated on every release](https://privatebin.info/jscoverage/privatebin.js.html#L565)

So, in conclusion, it is great to have all of these tools at our disposal, but the code quality would benefit a lot more from having more eyeballs on, and more brains behind it.

## Timeline

* 2019-12-24 – Property based unit test fails in a commit pushed to a PR.
* 2019-12-25 – Issue investigated, preliminary patch and issue description published.
* 2019-12-30 – Further investigations, proof-of-concept exploit demonstrated on a vulnerable test instance.
* 2020-01-03 – Discussed broader mitigation of user provided content injections, reviewed other possible cases.
* 2020-01-04 – Published a second patch based on review, escapes HTML in translation.
* 2020-01-05 – Started writing vulnerability report.
* 2020-01-11 – [Release published](https://github.com/PrivateBin/PrivateBin/releases/tag/1.3.2).
* 2020-01-11 – Vulnerability details published.
